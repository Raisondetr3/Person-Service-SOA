global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Statistics page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node

# Frontend - where HAProxy listens for incoming requests
frontend person_service_frontend
    bind *:8080 ssl crt haproxy-cert.pem
    mode http
    default_backend person_service_backend

    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Proto https

# Backend - dynamically discovered from Consul
backend person_service_backend
    mode http
    balance roundrobin

    # Health checks still performed by HAProxy for failover
    option httpchk
    http-check send meth GET uri /actuator/health ver HTTP/1.1 hdr Host localhost
    http-check expect status 200
{{- range service "person-service" }}
    # Dynamically discovered instance: {{ .ID }}
    server {{ .ID }} {{ .Address }}:{{ .Port }} check ssl verify none inter 10s fall 3 rise 2
{{- end }}

    http-response set-header X-Server-Instance %s
